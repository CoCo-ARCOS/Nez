<?php 
require "DBconnect.php";



/**
 * Validar que los datos no esten vacios
 */
if(isset($_GET['tokenuser']) && isset($_GET['sizefile']) && isset($_GET['chunks']) 
	  ) {

		stats($_GET["tokenuser"], $_GET["sizefile"], $_GET["chunks"],$_GET["sync"],
			$_GET["crypt_beginning"],  $_GET["crypt_sym"], $_GET["crypt_signature"], $_GET["crypt_cpabe"], $_GET["crypt_packer"], 
			$_GET["crypt_total"], $_GET["crypt"], $_GET["ida_time"], $_GET["raid_time"], $_GET["upload_time"], $_GET["delivery"], 
			$_GET["keyfile"], $_GET["organization"]);

}
else{
	stats($argv[1], $argv[2], $argv[3], $argv[4],$argv[5], $argv[6],$argv[7], $argv[8], $argv[9], $argv[10], $argv[11], $argv[12], $argv[13], $argv[14], $argv[15] );
}
/**
 * *
 * @param  [String] $tokenuser   	 [token del usuario]
 * @param  [String] $keyresource 	 [c6315fae8d30575901a44a0e8cfde3375be50e433
lave del recurso catÃ¡logo o grupo]
 * @param  [String] $namefile    	 [nombre del archivo]
 * @param  [String] $sizefile    	 [peso del archivo]
 * @param  [String] $dispersemode    [algoritmo de dispersion (IDA, RAID5, SINGLE )]
 */
 
function stats($tokenuser,$sizefile, $chunks, $sync, $beg, $sym, $signature, $cpabe, $packer, $total, $crypt, $ida_time, $raid_time, $upload_time, $delivery, $keyfile, $organization){

	$keyuser = getkeyuser($tokenuser);
	$ops = array();
	$ops["crypt_beginning"] = $beg;
	$ops["crypt_sym"] = $sym;
	$ops["crypt_signature"] = $signature;
	$ops["crypt_cpabe"] = $cpabe;
	$ops["crypt_packer"] = $packer;
	$ops["crypt_total"] = $total;
	$ops["crypt"] = $crypt;
	if ( isset($ida_time)){
		$ops["ida_time"] = $ida_time;
	}
	else if ( isset($raid_time)){
		$ops["raid_time"] = $raid_time;
	}
	$ops["upload"] = $upload_time;
	$ops["delivery"] = $delivery;
	

	try{
		$connection = getConnection();
	
		$oo = "sync";
		$dbh = $connection->prepare("INSERT INTO stats(tokenuser, sizefile, 
		chunks, time, type, keyfile, organization)
		VALUES(:tokenuser, :sizefile, :chunks, :time, :type, :keyfile, :organization)");
		
		$dbh->bindParam(":tokenuser", $tokenuser);
		$dbh->bindParam(":sizefile", $sizefile);
		$dbh->bindParam(":chunks", $chunks);
		$dbh->bindParam(":time", $sync);
		$dbh->bindParam(":type", $oo);
		$dbh->bindParam(":organization", $organization);
		$dbh->bindParam(":keyfile", $keyfile);
		$dbh->execute();
		$id_root= $connection->lastInsertId("stats_id_seq");

		foreach($ops as $id=>$o){
				$dbh = $connection->prepare("INSERT INTO stats(tokenuser, sizefile, 
					chunks, time, type, id_root, keyfile, organization)
					VALUES(:tokenuser, :sizefile, :chunks, :time, :type, :id_root, :keyfile, :organization)");
	
				$dbh->bindParam(":tokenuser", $tokenuser);
				$dbh->bindParam(":sizefile", $sizefile);
				$dbh->bindParam(":chunks", $chunks);
				$dbh->bindParam(":time", $o);
				$dbh->bindParam(":type", $id);
				$dbh->bindParam(":keyfile", $keyfile);
				$dbh->bindParam(":id_root", $id_root);
				$dbh->bindParam(":organization", $organization);
				$dbh->execute();
		}


		        //curl_exec(curl_init("163.117.148.139/multi2/stats.php?tokenuser=".$tokenuser."&sizefile=".$sizefile."&chunks=".$chunks."&time=".$time."&type=".$type.
                        //"&id_root=".$id_root));
  
		$connection = null;
		header('Content-type: application/json; charset=utf-8');
		
		echo json_encode(array("status" => 200, "message"=> "OK"  ));
	}
	catch(PDOException $e) {
		header('Content-type: application/json; charset=utf-8');
		echo json_encode(array("status" => 403 ,"message" => "Forbidden"));
	}
}
?>
